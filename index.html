<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M2 Hold Timer</title>
  <style>
    :root{
      --bg: #0b0f14;
      --text: #e7eef8;
      --muted: #9fb0c7;

      --border: rgba(231, 238, 248, 0.14);
      --border2: rgba(231, 238, 248, 0.22);

      --accent: #7aa2ff;
      --good: #56d364;
      --bad: #ff4d4d;

      --panelGrad: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      line-height: 1.35;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(122,162,255,0.18), transparent 60%),
                  radial-gradient(900px 500px at 10% 10%, rgba(86,211,100,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 28px 18px;
    }

    .app {
      width: min(820px, 96vw);
      background: var(--panelGrad);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
    }

    header { display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom: 8px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: 0.2px; }

    .hint {
      color: var(--muted);
      margin-top: 6px;
      font-size: 13px;
    }

    .box {
      width: 100%;
      height: 260px;
      border: 2px dashed var(--border2);
      border-radius: 14px;
      display: grid;
      place-items: center;
      user-select: none;
      margin-top: 14px;
      padding: 14px;
      background: var(--panelGrad);
      outline: none;
      position: relative;
    }

    /* Centered state only */
    .stateOnly {
      display: grid;
      place-items: center;
      gap: 10px;
      text-align: center;
      min-width: 220px;
    }

    .stateLine {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 18px;
      text-transform: uppercase;
    }

    /* Status dot */
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      border: 1px solid rgba(231,238,248,0.35);
      background: rgba(231,238,248,0.10);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .dot.idle { background: rgba(231,238,248,0.10); }
    .dot.armed { background: rgba(122,162,255,0.55); border-color: rgba(122,162,255,0.75); box-shadow: 0 0 18px rgba(122,162,255,0.20); }
    .dot.measuring {
      background: rgba(122,162,255,0.75);
      border-color: rgba(122,162,255,0.90);
      box-shadow: 0 0 22px rgba(122,162,255,0.28);
      animation: throb 700ms ease-in-out infinite;
    }
    @keyframes throb {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }

    /* Check/X flash (keep) */
    .flashIcons {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 2px;
      height: 22px; /* reserve space so it doesn't jump */
    }

    .icon {
      width: 18px; height: 18px;
      display: inline-grid;
      place-items: center;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,0.03);
      opacity: 0.0;
      transform: translateY(1px) scale(0.95);
      transition: opacity 120ms ease, transform 120ms ease;
      font-weight: 900;
      line-height: 1;
    }
    .icon.show { opacity: 1; transform: translateY(0) scale(1); }
    .icon.ok { border-color: rgba(86,211,100,0.55); background: rgba(86,211,100,0.12); }
    .icon.bad { border-color: rgba(255,77,77,0.55); background: rgba(255,77,77,0.12); }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
    }

    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      cursor: pointer;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
    }
    button:hover { background: rgba(255,255,255,0.07); border-color: rgba(122,162,255,0.45); }
    button:active { transform: translateY(1px); }

    /* Styled checkbox */
    .check {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,0.03);
      user-select: none;
    }
    .check input { display: none; }
    .check .boxy {
      width: 18px; height: 18px;
      border-radius: 6px;
      border: 1px solid var(--border2);
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
      transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
    }
    .check .label { color: var(--text); font-size: 13px; white-space: nowrap; }
    .check input:checked + .boxy {
      border-color: rgba(122,162,255,0.65);
      background: rgba(122,162,255,0.18);
      box-shadow: inset 0 0 0 2px rgba(122,162,255,0.22);
    }
    .check .tick {
      width: 10px; height: 6px;
      border-left: 2px solid transparent;
      border-bottom: 2px solid transparent;
      transform: rotate(-45deg);
      margin-top: -1px;
    }
    .check input:checked + .boxy .tick {
      border-left-color: var(--text);
      border-bottom-color: var(--text);
    }

    .metric {
      display: inline-flex;
      align-items: baseline;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border2);
      background: rgba(122,162,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(122,162,255,0.08);
      white-space: nowrap;
    }
    .metric .label {
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .metric .value {
      font-size: 22px;
      font-weight: 800;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    .metric.last {
      background: rgba(86,211,100,0.10);
      box-shadow: inset 0 0 0 1px rgba(86,211,100,0.10);
    }

    /* Special effect when avg is 35-40ms */
    .avg-special {
      animation: avgPulse 900ms ease-out 1;
      box-shadow:
        inset 0 0 0 1px rgba(255, 204, 0, 0.22),
        0 0 22px rgba(255, 204, 0, 0.20),
        0 0 44px rgba(255, 204, 0, 0.10);
      border-color: rgba(255, 204, 0, 0.45) !important;
      background: rgba(255, 204, 0, 0.10) !important;
    }
    @keyframes avgPulse {
      0% { transform: scale(1); }
      40% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 860px) { .grid2 { grid-template-columns: 1fr; } }

    .panel {
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      overflow: hidden;
    }

    table { border-collapse: collapse; width: 100%; }

    thead th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      text-align: right;
    }
    th:first-child, td:first-child { text-align: left; }

    tbody td {
      border-bottom: 1px solid rgba(231,238,248,0.08);
      padding: 10px 10px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:hover { background: rgba(255,255,255,0.03); }

    .footer-note {
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid rgba(231,238,248,0.08);
      background: rgba(255,255,255,0.02);
    }

    .msCell { font-weight: 800; }
    .mono { font-variant-numeric: tabular-nums; }

    .smallBtn {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>M2 Hold Timer</h1>
    </header>

    <div class="hint">Tip: Use the box area so the browser keeps focus. Right-click menu is disabled inside the box.</div>

    <div id="box" class="box" tabindex="0" role="application" aria-label="Test area">
      <div class="stateOnly" aria-live="polite">
        <div class="stateLine">
          <span class="dot idle" id="stateDot" aria-hidden="true"></span>
          <span id="stateText">IDLE</span>
        </div>

        <div class="flashIcons" aria-hidden="true">
          <span class="icon ok" id="okIcon">✓</span>
          <span class="icon bad" id="badIcon">✕</span>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="reset">Reset tries</button>

      <label class="check" title="When 10 valid tries are reached, log the average then clear the 10 tries.">
        <input id="sessionLogToggle" type="checkbox" />
        <span class="boxy"><span class="tick"></span></span>
        <span class="label">Log avg every 10 (auto-clear)</span>
      </label>

      <div class="metric" id="avgMetric" aria-label="Average timing">
        <div class="label" id="avgLabel">Avg (last 10)</div>
        <div class="value mono" id="avgValue">—</div>
      </div>

      <div class="metric last" id="lastMetric" aria-label="Last timing">
        <div class="label">Last</div>
        <div class="value mono" id="lastValue">—</div>
      </div>
    </div>

    <div class="grid2">
      <div class="panel" aria-label="Last 10 tries">
        <table>
          <thead>
            <tr>
              <th>Try</th>
              <th>Hold (ms)</th>
              <th>Hold (s)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="footer-note">Shows exactly 10 slots. When enabled, reaching 10 logs the avg and clears.</div>
      </div>

      <div class="panel" aria-label="Average history">
        <table>
          <thead>
            <tr>
              <th>Session</th>
              <th>Avg (ms)</th>
            </tr>
          </thead>
          <tbody id="avgHistoryBody"></tbody>
        </table>
        <div class="footer-note">
          Average History (per 10 valid tries)
          <button id="clearAvgHistory" class="smallBtn" style="float:right;">Clear</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const box = document.getElementById('box');

  const stateDot = document.getElementById('stateDot');
  const stateText = document.getElementById('stateText');
  const okIcon = document.getElementById('okIcon');
  const badIcon = document.getElementById('badIcon');

  const tbody = document.getElementById('tbody');
  const avgHistoryBody = document.getElementById('avgHistoryBody');

  const avgMetric = document.getElementById('avgMetric');
  const avgLabel = document.getElementById('avgLabel');
  const avgValue = document.getElementById('avgValue');
  const lastValue = document.getElementById('lastValue');

  const resetBtn = document.getElementById('reset');
  const sessionLogToggle = document.getElementById('sessionLogToggle');
  const clearAvgHistoryBtn = document.getElementById('clearAvgHistory');

  // State
  let m1Down = false;
  let m2Down = false;
  let measuring = false;
  let startTime = 0;

  const tries = [];
  const avgHistory = [];

  function now() {
    return (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
  }

  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function msToColor(ms) {
    if (!Number.isFinite(ms)) return 'inherit';
    if (ms <= 31 && ms >= 20) return 'rgb(86, 211, 100)';
    if (ms >= 50) return 'rgb(255, 77, 77)';

    if (ms > 31 && ms < 50) {
      const t = (ms - 31) / (50 - 31);
      const r = Math.round(86 + t * (255 - 86));
      const g = Math.round(211 + t * (77 - 211));
      const b = Math.round(100 + t * (77 - 100));
      return `rgb(${r}, ${g}, ${b})`;
    }

    if (ms < 20) {
      const t = clamp((20 - ms) / 10, 0, 1);
      const r = Math.round(86 - t * 16);
      const g = Math.round(211 + t * 10);
      const b = Math.round(100 + t * 80);
      return `rgb(${r}, ${g}, ${b})`;
    }
    return 'inherit';
  }

  function setState(kind, label) {
    stateDot.className = `dot ${kind}`;
    stateText.textContent = label;
  }

  let flashTimer = null;
  function flashIcon(which) {
    clearTimeout(flashTimer);
    okIcon.classList.remove('show');
    badIcon.classList.remove('show');

    if (which === 'ok') okIcon.classList.add('show');
    if (which === 'bad') badIcon.classList.add('show');

    flashTimer = setTimeout(() => {
      okIcon.classList.remove('show');
      badIcon.classList.remove('show');
    }, 450);
  }

  function updateUI() {
    if (!m1Down && !measuring) {
      setState('idle', 'IDLE');
    } else if (m1Down && !measuring) {
      setState('armed', 'ARMED');
    } else if (measuring) {
      setState('measuring', 'MEASURING');
    }
  }

  function computeAvg(arr) {
    if (!arr.length) return NaN;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }

  function clearSpecialAvg() {
    avgMetric.classList.remove('avg-special');
  }

  let specialTimer = null;
  function triggerSpecialAvg() {
    avgMetric.classList.add('avg-special');
    if (specialTimer) clearTimeout(specialTimer);
    specialTimer = setTimeout(() => avgMetric.classList.remove('avg-special'), 1200);
  }

  function renderTriesTable() {
    tbody.innerHTML = '';

    for (let i = 0; i < 10; i++) {
      const ms = tries[i];
      const tr = document.createElement('tr');

      const tdTry = document.createElement('td');
      const tdMs = document.createElement('td');
      const tdS = document.createElement('td');

      tdTry.textContent = `#${i + 1}`;

      if (typeof ms === 'number') {
        tdMs.textContent = ms.toFixed(2);
        tdMs.className = 'msCell mono';
        tdMs.style.color = msToColor(ms);
        tdS.textContent = (ms / 1000).toFixed(4);
        tdS.className = 'mono';
      } else {
        tdMs.textContent = '—';
        tdMs.className = 'mono';
        tdMs.style.color = 'rgba(231,238,248,0.35)';
        tdS.textContent = '—';
        tdS.className = 'mono';
        tdS.style.color = 'rgba(231,238,248,0.35)';
      }

      tr.appendChild(tdTry);
      tr.appendChild(tdMs);
      tr.appendChild(tdS);
      tbody.appendChild(tr);
    }

    if (tries.length) {
      const last = tries[tries.length - 1];
      lastValue.textContent = `${last.toFixed(2)} ms`;
      lastValue.style.color = msToColor(last);
    } else {
      lastValue.textContent = '—';
      lastValue.style.color = '';
    }

    if (tries.length) {
      const avg = computeAvg(tries);
      avgLabel.textContent = `Avg (last ${tries.length})`;
      avgValue.textContent = `${avg.toFixed(2)} ms`;
      avgValue.style.color = msToColor(avg);

      // special when full 10 and avg 35-40
      if (tries.length === 10 && avg >= 35 && avg <= 40) triggerSpecialAvg();
      else clearSpecialAvg();
    } else {
      avgLabel.textContent = 'Avg (last 10)';
      avgValue.textContent = '—';
      avgValue.style.color = '';
      clearSpecialAvg();
    }
  }

  function renderAvgHistory() {
    avgHistoryBody.innerHTML = '';
    avgHistory.forEach((ms, idx) => {
      const tr = document.createElement('tr');
      const tdSess = document.createElement('td');
      const tdAvg = document.createElement('td');

      tdSess.textContent = `#${idx + 1}`;
      tdAvg.textContent = ms.toFixed(2);
      tdAvg.className = 'msCell mono';
      tdAvg.style.color = msToColor(ms);

      tr.appendChild(tdSess);
      tr.appendChild(tdAvg);
      avgHistoryBody.appendChild(tr);
    });
  }

  function resetTriesOnly() {
    m1Down = false;
    m2Down = false;
    measuring = false;
    startTime = 0;
    tries.length = 0;
    renderTriesTable();
    updateUI();
  }

  function commitSessionAverageAndClear() {
    const avg = computeAvg(tries);
    if (Number.isFinite(avg)) {
      avgHistory.push(avg);
      renderAvgHistory();
    }
    tries.length = 0;
    renderTriesTable();
  }

  // Disable context menu
  box.addEventListener('contextmenu', (e) => e.preventDefault());
  box.addEventListener('pointerdown', () => box.focus());

  box.addEventListener('mousedown', (e) => {
    if (e.button === 0) m1Down = true;
    if (e.button === 2) {
      m2Down = true;
      if (m1Down && !measuring) {
        measuring = true;
        startTime = now();
      }
    }
    updateUI();
  });

  box.addEventListener('mouseup', (e) => {
    if (e.button === 0) {
      m1Down = false;

      // invalidate if measuring
      if (measuring) {
        measuring = false;
        startTime = 0;
        flashIcon('bad');
      }
      updateUI();
    }

    if (e.button === 2) {
      m2Down = false;

      if (measuring) {
        if (m1Down) {
          const duration = now() - startTime;
          tries.push(duration);
          if (tries.length > 10) tries.shift();
          renderTriesTable();
          flashIcon('ok');

          if (sessionLogToggle.checked && tries.length === 10) {
            const avg = computeAvg(tries);
            if (avg >= 35 && avg <= 40) triggerSpecialAvg();
            commitSessionAverageAndClear();
          }
        } else {
          flashIcon('bad');
        }

        measuring = false;
        startTime = 0;
        updateUI();
      } else {
        updateUI();
      }
    }
  });

  box.addEventListener('mouseleave', () => {
    if (measuring && (!m2Down || !m1Down)) {
      measuring = false;
      startTime = 0;
    }
    updateUI();
  });

  resetBtn.addEventListener('click', resetTriesOnly);
  clearAvgHistoryBtn.addEventListener('click', () => {
    avgHistory.length = 0;
    renderAvgHistory();
  });

  // Init
  renderTriesTable();
  renderAvgHistory();
  updateUI();
  box.focus();
})();
</script>
</body>
</html>
